<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ê¸‰ ì‡¼í•‘ëª°</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            min-height: 100vh;
            color: #92400e;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .mobile-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(146, 64, 14, 0.1);
            margin-bottom: 20px;
            border: 2px solid #fde68a;
        }

        .btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #92400e 0%, #451a03 100%);
            box-shadow: 0 4px 15px rgba(146, 64, 14, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(146, 64, 14, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: #92400e;
            border: 2px solid #fde68a;
            box-shadow: none;
        }

        .btn-outline:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 0 4px 0 0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #fde68a;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
            background: #fffbeb;
            color: #92400e;
        }

        .input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .pin-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            font-weight: bold;
        }

        .pin-container {
            text-align: center;
        }

        .points-display {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
            border: 3px solid #f59e0b;
        }

        .points-number {
            font-size: 48px;
            font-weight: bold;
            color: #92400e;
            margin-bottom: 8px;
        }

        .points-label {
            font-size: 16px;
            color: #d97706;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .student-btn {
            background: white;
            border: 2px solid #fde68a;
            padding: 16px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            color: #92400e;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .student-btn:hover {
            background: #fef3c7;
            border-color: #f59e0b;
            transform: translateY(-2px);
        }

        /* ì»´íŒ©íŠ¸í•œ ìƒì  ì¹´ë“œ */
        .shop-item-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(146, 64, 14, 0.1);
            border: 2px solid #fde68a;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .shop-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(146, 64, 14, 0.15);
            border-color: #f59e0b;
        }

        .shop-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 auto 12px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fde68a;
        }

        .shop-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .shop-item-emoji {
            font-size: 32px;
            text-align: center;
            margin-bottom: 8px;
        }

        .shop-item-price {
            font-size: 20px;
            font-weight: bold;
            color: #059669;
            text-align: center;
            margin-bottom: 8px;
        }

        .shop-item-title {
            font-size: 16px;
            font-weight: bold;
            color: #92400e;
            text-align: center;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shop-item-status {
            text-align: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .status-available {
            background: #dcfce7;
            color: #059669;
        }

        .status-sold {
            background: #fee2e2;
            color: #dc2626;
        }

        /* ë‚´ ë¬¼ê±´ ê°€ë¡œ ë ˆì´ì•„ì›ƒ */
        .my-item-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(146, 64, 14, 0.1);
            border: 2px solid #fde68a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-item-card.sold {
            opacity: 0.7;
            background: #f9fafb;
        }

        .my-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fde68a;
            flex-shrink: 0;
        }

        .my-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .my-item-emoji {
            font-size: 24px;
        }

        .my-item-info {
            flex: 1;
        }

        .my-item-title {
            font-size: 18px;
            font-weight: bold;
            color: #92400e;
            margin-bottom: 4px;
        }

        .my-item-price {
            font-size: 16px;
            font-weight: bold;
            color: #059669;
            margin-bottom: 4px;
        }

        .my-item-status {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .my-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .student-points {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #fde68a;
        }

        .student-points:last-child {
            border-bottom: none;
        }

        .transaction-item {
            padding: 12px 0;
            border-bottom: 1px solid #fde68a;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .back-btn {
            background: transparent;
            border: none;
            color: #92400e;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #fef3c7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #d97706;
        }

        .online-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #059669;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .online-indicator.offline {
            background: #dc2626;
        }

        .photo-upload {
            border: 2px dashed #fde68a;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fffbeb;
        }

        .photo-upload:hover {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .photo-upload.has-image {
            border-color: #059669;
            background: #ecfdf5;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 0 auto;
            border-radius: 8px;
            object-fit: cover;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .category-btn {
            background: white;
            border: 2px solid #fde68a;
            padding: 12px 8px;
            border-radius: 8px;
            font-size: 14px;
            color: #92400e;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .category-btn:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .category-btn.selected {
            background: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            background: white;
            border: 2px solid #fde68a;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: #92400e;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .filter-tab.active {
            background: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #92400e;
        }

        .modal-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .modal-emoji {
            font-size: 64px;
            text-align: center;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .shop-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .points-number {
                font-size: 36px;
            }

            .filter-tabs {
                justify-content: center;
            }

            .filter-tab {
                font-size: 12px;
                padding: 6px 12px;
            }

            .my-item-card {
                flex-direction: column;
                text-align: center;
            }

            .my-item-image {
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <h2>ğŸ”„ í•™ê¸‰ ì‡¼í•‘ëª° ë¡œë”© ì¤‘...</h2>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
    </div>
    
    <div class="online-indicator" id="onlineStatus">ğŸŸ¢ ì˜¨ë¼ì¸</div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAdX_kxEdXd8loilPuQsHeRj2zxXGHAKx8",
            authDomain: "classroom-market-e1923.firebaseapp.com",
            projectId: "classroom-market-e1923",
            storageBucket: "classroom-market-e1923.firebasestorage.app",
            messagingSenderId: "55093541170",
            appId: "1:55093541170:web:8b275f6d84b928cf5a7f2b"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ì¹´í…Œê³ ë¦¬ ì •ì˜
        const CATEGORIES = [
            { id: 'electronics', name: 'ğŸ“± ì „ìê¸°ê¸°', emoji: 'ğŸ“±' },
            { id: 'stationery', name: 'ğŸ“š í•™ìš©í’ˆ', emoji: 'ğŸ“š' },
            { id: 'clothing', name: 'ğŸ‘• ì˜ë¥˜ ë° ì¡í™”', emoji: 'ğŸ‘•' },
            { id: 'toys', name: 'ğŸ§¸ ì¥ë‚œê°', emoji: 'ğŸ§¸' },
            { id: 'books', name: 'ğŸ“– ë„ì„œ', emoji: 'ğŸ“–' },
            { id: 'etc', name: 'ğŸ“¦ ê¸°íƒ€', emoji: 'ğŸ“¦' }
        ];

        class ClassMarket {
            constructor() {
                this.currentPage = 'home';
                this.currentUser = null;
                this.selectedStudent = null;
                this.selectedStudentForTransactions = null;
                this.selectedCategory = '';
                this.selectedImageFile = null;
                this.shopCategoryFilter = 'all';
                this.editingItem = null;
                
                // êµì‚¬ ì„¤ì • (ê¸°ë³¸ê°’)
                this.teacherSettings = {
                    className: 'ìš°ë¦¬ ë°˜',
                    pin: '0000',
                    studentCount: 25,
                    defaultPoints: 100,
                    isFirstTime: true
                };
                
                // ì‹¤ì‹œê°„ ë°ì´í„°
                this.students = [];
                this.items = [];
                this.transactions = [];
                
                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë“¤
                this.unsubscribers = [];
                
                this.init();
            }
            
            // ì´ˆê¸°í™”
            async init() {
                try {
                    await this.loadTeacherSettings();
                    this.setupRealtimeListeners();
                    this.render();
                    this.updateOnlineStatus(true);
                } catch (error) {
                    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    this.updateOnlineStatus(false);
                }
            }
            
            // ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateOnlineStatus(isOnline) {
                const indicator = document.getElementById('onlineStatus');
                if (indicator) {
                    if (isOnline) {
                        indicator.textContent = 'ğŸŸ¢ ì˜¨ë¼ì¸';
                        indicator.className = 'online-indicator';
                    } else {
                        indicator.textContent = 'ğŸ”´ ì˜¤í”„ë¼ì¸';
                        indicator.className = 'online-indicator offline';
                    }
                }
            }
            
            // êµì‚¬ ì„¤ì • ë¡œë“œ
            async loadTeacherSettings() {
                try {
                    const doc = await db.collection('settings').doc('teacher').get();
                    if (doc.exists) {
                        this.teacherSettings = { ...this.teacherSettings, ...doc.data() };
                    } else {
                        // ê¸°ë³¸ ì„¤ì • ì €ì¥
                        await this.saveTeacherSettingsToDb();
                        await this.createDefaultStudents();
                    }
                } catch (error) {
                    console.error('êµì‚¬ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
            
            // ê¸°ë³¸ í•™ìƒ ìƒì„±
            async createDefaultStudents() {
                const batch = db.batch();
                
                for (let i = 1; i <= this.teacherSettings.studentCount; i++) {
                    const studentRef = db.collection('students').doc(`student_${i}`);
                    batch.set(studentRef, {
                        id: i,
                        name: `í•™ìƒ${i}`,
                        pin: String(1000 + i - 1).padStart(4, '0'),
                        points: this.teacherSettings.defaultPoints,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
            }
            
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupRealtimeListeners() {
                // í•™ìƒ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                const studentsUnsubscriber = db.collection('students')
                    .orderBy('id')
                    .onSnapshot((snapshot) => {
                        this.students = [];
                        snapshot.forEach((doc) => {
                            this.students.push({ docId: doc.id, ...doc.data() });
                        });
                        
                        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                        if (this.currentUser && this.currentUser.id !== 'teacher') {
                            const updatedUser = this.students.find(s => s.id === this.currentUser.id);
                            if (updatedUser) {
                                this.currentUser = { ...this.currentUser, ...updatedUser };
                            }
                        }
                        
                        this.render();
                    });
                
                // ìƒí’ˆ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                const itemsUnsubscriber = db.collection('items')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        this.items = [];
                        snapshot.forEach((doc) => {
                            this.items.push({ docId: doc.id, ...doc.data() });
                        });
                        this.render();
                    });
                
                // ê±°ë˜ ë‚´ì—­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                const transactionsUnsubscriber = db.collection('transactions')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        this.transactions = [];
                        snapshot.forEach((doc) => {
                            this.transactions.push({ docId: doc.id, ...doc.data() });
                        });
                        this.render();
                    });
                
                this.unsubscribers.push(studentsUnsubscriber, itemsUnsubscriber, transactionsUnsubscriber);
            }
            
            // ì´ë¯¸ì§€ ì••ì¶•
            async compressImage(file, maxWidth = 800, quality = 0.7) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ í¬ê¸° ì¡°ì •
                        const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', quality);
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            }
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ
            async uploadImage(file) {
                try {
                    // ì´ë¯¸ì§€ ì••ì¶•
                    const compressedFile = await this.compressImage(file);
                    
                    // íŒŒì¼ëª… ìƒì„± (timestamp + random)
                    const fileName = `items/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                    
                    // Firebase Storageì— ì—…ë¡œë“œ
                    const storageRef = storage.ref().child(fileName);
                    const snapshot = await storageRef.put(compressedFile);
                    
                    // ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸°
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    return downloadURL;
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            // í˜ì´ì§€ ì„¤ì •
            setPage(page) {
                this.currentPage = page;
                this.selectedImageFile = null;
                if (page !== 'edit-item') {
	            this.selectedCategory = ' ';
	            this.editingItem = null;
		}

                this.render();
            }
            
            // ì‚¬ìš©ì ì„¤ì •
            setUser(user) {
                this.currentUser = user;
            }
            
            // PIN í™•ì¸
            verifyPin(studentId, pin) {
                const student = this.students.find(s => s.id === studentId);
                return student && student.pin === pin;
            }
            
            // ìƒí’ˆ ì¶”ê°€
            async addItem(title, description, price, category, imageUrl = null) {
                if (!title || !price || !category) return false;
                
                try {
                    // ì¹´í…Œê³ ë¦¬ë³„ ìë™ ì´ëª¨ì§€ í• ë‹¹
                    const categoryData = CATEGORIES.find(c => c.id === category);
                    const emoji = categoryData ? categoryData.emoji : 'ğŸ“¦';
                    
                    await db.collection('items').add({
                        title,
                        description: description || '',
                        price: parseInt(price),
                        emoji,
                        category,
                        imageUrl,
                        sellerId: this.currentUser.id,
                        sellerName: this.currentUser.name,
                        available: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            
            // ìƒí’ˆ ìˆ˜ì •
            async updateItem(itemId, title, description, price, category, imageUrl = null) {
                try {
                    const categoryData = CATEGORIES.find(c => c.id === category);
                    const emoji = categoryData ? categoryData.emoji : 'ğŸ“¦';
                    
                    const updateData = {
                        title,
                        description: description || '',
                        price: parseInt(price),
                        emoji,
                        category,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (imageUrl !== null) {
                        updateData.imageUrl = imageUrl;
                    }
                    
                    await db.collection('items').doc(itemId).update(updateData);
                    return true;
                } catch (error) {
                    console.error('ìƒí’ˆ ìˆ˜ì • ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            
            // ìƒí’ˆ ì‚­ì œ
            async deleteItem(itemId) {
                if (!confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return false;
                }
                
                try {
                    await db.collection('items').doc(itemId).delete();
                    return true;
                } catch (error) {
                    console.error('ìƒí’ˆ ì‚­ì œ ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            
            // ìƒí’ˆ êµ¬ë§¤
            async buyItem(item) {
                if (!item.available || item.sellerId === this.currentUser.id) return false;
                if (this.currentUser.points < item.price) {
                    alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return false;
                }
                // êµ¬ë§¤ í™•ì¸ íŒì—…
		const confirmMessage = `ì •ë§ë¡œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìƒí’ˆ: ${item.title}\nê°€ê²©: ${item.price.toLocaleString()}P\níŒë§¤ì: ${item.sellerName}\n\nêµ¬ë§¤ í›„ ${this.currentUser.points - item.price}Pê°€ ë‚¨ìŠµë‹ˆë‹¤.`;
    
    		if (!confirm(confirmMessage)) {
                   return false;  // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ì„ íƒí•œ ê²½ìš°
 		}


                try {
                    // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë™ì‹œì„± ë¬¸ì œ í•´ê²°
                    await db.runTransaction(async (transaction) => {
                        // ìƒí’ˆ ìƒíƒœ í™•ì¸
                        const itemRef = db.collection('items').doc(item.docId);
                        const itemDoc = await transaction.get(itemRef);
                        
                        if (!itemDoc.exists || !itemDoc.data().available) {
                            throw new Error('ì´ë¯¸ íŒë§¤ëœ ìƒí’ˆì…ë‹ˆë‹¤.');
                        }
                        
                        // êµ¬ë§¤ì, íŒë§¤ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        const buyer = this.students.find(s => s.id === this.currentUser.id);
                        const seller = this.students.find(s => s.id === item.sellerId);
                        
                        if (!buyer || !seller) {
                            throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                        
                        if (buyer.points < item.price) {
                            throw new Error('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                        }
                        
                        // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
                        const buyerRef = db.collection('students').doc(buyer.docId);
                        const sellerRef = db.collection('students').doc(seller.docId);
                        
                        transaction.update(buyerRef, {
                            points: buyer.points - item.price
                        });
                        
                        transaction.update(sellerRef, {
                            points: seller.points + item.price
                        });
                        
                        // ìƒí’ˆì„ íŒë§¤ ì™„ë£Œë¡œ ë³€ê²½
                        transaction.update(itemRef, {
                            available: false,
                            buyerId: buyer.id,
                            buyerName: buyer.name,
                            soldAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
                        const transactionRef = db.collection('transactions').doc();
                        transaction.set(transactionRef, {
                            buyerId: buyer.id,
                            buyerName: buyer.name,
                            sellerId: seller.id,
                            sellerName: seller.name,
                            itemId: item.docId,
                            itemTitle: item.title,
                            price: item.price,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    return true;
                } catch (error) {
                    console.error('êµ¬ë§¤ ì˜¤ë¥˜:', error);
                    alert(error.message || 'êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return false;
                }
            }
            
            // í•™ìƒ ì´ë¦„ ì—…ë°ì´íŠ¸
            async updateStudentName(studentId, newName) {
                try {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        await db.collection('students').doc(student.docId).update({
                            name: newName
                        });
                    }
                } catch (error) {
                    console.error('ì´ë¦„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
            }
            
            // í•™ìƒ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
            async updateStudentPoints(studentId, newPoints) {
                try {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        await db.collection('students').doc(student.docId).update({
                            points: parseInt(newPoints)
                        });
                    }
                } catch (error) {
                    console.error('í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
            }
            
            // í•™ìƒ PIN ì—…ë°ì´íŠ¸
            async updateStudentPin(studentId, newPin) {
                try {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        await db.collection('students').doc(student.docId).update({
                            pin: newPin
                        });
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('PIN ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            
            // êµì‚¬ ì„¤ì •ì„ DBì— ì €ì¥
            async saveTeacherSettingsToDb() {
                try {
                    await db.collection('settings').doc('teacher').set(this.teacherSettings);
                } catch (error) {
                    console.error('êµì‚¬ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                }
            }
            
            // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            async resetAllData() {
                if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•™ìƒ ì •ë³´, ìƒí’ˆ, ê±°ë˜ ë‚´ì—­ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                    try {
                        // Firestore ì»¬ë ‰ì…˜ë“¤ ì‚­ì œ
                        const batch = db.batch();
                        
                        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                        const studentsSnapshot = await db.collection('students').get();
                        studentsSnapshot.forEach(doc => batch.delete(doc.ref));
                        
                        const itemsSnapshot = await db.collection('items').get();
                        itemsSnapshot.forEach(doc => batch.delete(doc.ref));
                        
                        const transactionsSnapshot = await db.collection('transactions').get();
                        transactionsSnapshot.forEach(doc => batch.delete(doc.ref));
                        
                        await batch.commit();
                        
                        // ê¸°ë³¸ í•™ìƒ ë‹¤ì‹œ ìƒì„±
                        await this.createDefaultStudents();
                        
                        alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error('ë°ì´í„° ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                        alert('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            }
            
            // ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬
            async processExcelData(data) {
                try {
                    const batch = db.batch();
                    
                    // ê¸°ì¡´ í•™ìƒ ë°ì´í„° ì‚­ì œ
                    const existingStudents = await db.collection('students').get();
                    existingStudents.forEach(doc => batch.delete(doc.ref));
                    
                    // ìƒˆ í•™ìƒ ë°ì´í„° ì¶”ê°€
                    data.forEach((row, index) => {
                        const number = row['ë²ˆí˜¸'] || row['ì¶œì„ë²ˆí˜¸'] || row['No'] || row['number'] || (index + 1);
                        const name = row['ì´ë¦„'] || row['ì„±ëª…'] || row['name'] || row['Name'] || `í•™ìƒ${number}`;
                        const pin = String(row['PIN'] || row['pin'] || row['ë¹„ë°€ë²ˆí˜¸'] || (1000 + index));
                        const points = parseInt(row['í¬ì¸íŠ¸'] || row['ì ìˆ˜'] || row['points'] || row['Points'] || 100);
                        
                        const studentRef = db.collection('students').doc(`student_${number}`);
                        batch.set(studentRef, {
                            id: parseInt(number),
                            name: name,
                            pin: pin.padStart(4, '0'),
                            points: points,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                    
                    // êµì‚¬ ì„¤ì • ì—…ë°ì´íŠ¸
                    this.teacherSettings.studentCount = data.length;
                    await this.saveTeacherSettingsToDb();
                    
                } catch (error) {
                    console.error('ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            // ë¹ ë¥¸ ì„¤ì •
            async quickSetup(count, points) {
                try {
                    const batch = db.batch();
                    
                    // ê¸°ì¡´ í•™ìƒ ë°ì´í„° ì‚­ì œ
                    const existingStudents = await db.collection('students').get();
                    existingStudents.forEach(doc => batch.delete(doc.ref));
                    
                    // ìƒˆ í•™ìƒ ë°ì´í„° ìƒì„±
                    for (let i = 1; i <= count; i++) {
                        const studentRef = db.collection('students').doc(`student_${i}`);
                        batch.set(studentRef, {
                            id: i,
                            name: `í•™ìƒ${i}`,
                            pin: String(1000 + i - 1).padStart(4, '0'),
                            points: points,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    await batch.commit();
                    
                    this.teacherSettings.studentCount = count;
                    this.teacherSettings.defaultPoints = points;
                    await this.saveTeacherSettingsToDb();
                    
                } catch (error) {
                    console.error('ë¹ ë¥¸ ì„¤ì • ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            // ì¹´í…Œê³ ë¦¬ ì„ íƒ
            selectCategory(categoryId) {
                this.selectedCategory = categoryId;
                this.render();
            }
            
            // ì´ë¯¸ì§€ ì„ íƒ
            handleImageSelect(file) {
                if (file && file.type.startsWith('image/')) {
                    this.selectedImageFile = file;
                    this.render();
                } else {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            }
            
            // ìƒì  ì¹´í…Œê³ ë¦¬ í•„í„°
            setShopCategoryFilter(category) {
                this.shopCategoryFilter = category;
                this.render();
            }
            
            // ìƒí’ˆ ìƒì„¸ë³´ê¸° ëª¨ë‹¬
            showItemDetail(item) {
                const category = CATEGORIES.find(c => c.id === item.category);
                const isMyItem = item.sellerId === this.currentUser.id;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                        
                        ${item.imageUrl ? 
                            `<img src="${item.imageUrl}" class="modal-image" alt="${item.title}">` :
                            `<div class="modal-emoji">${item.emoji}</div>`
                        }
                        
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 12px; color: #9ca3af; background: #f3f4f6; padding: 4px 8px; border-radius: 12px; display: inline-block; margin-bottom: 8px;">
                                ${category ? category.name : 'ğŸ“¦ ê¸°íƒ€'}
                            </div>
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 8px;">${item.title}</h2>
                            <div style="font-size: 28px; font-weight: bold; color: #059669; margin-bottom: 16px;">${item.price}P</div>
                        </div>
                        
                        ${item.description ? 
                            `<div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="color: #92400e;">${item.description}</p>
                            </div>` : ''
                        }
                        
                        <div style="text-align: center; margin-bottom: 16px; font-size: 14px; color: #9ca3af;">
                            <p>íŒë§¤ì: ${item.sellerName}</p>
                            <p>ë“±ë¡ì¼: ${item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : 'ìµœê·¼'}</p>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div class="shop-item-status ${item.available ? 'status-available' : 'status-sold'}">
                                ${item.available ? 'ğŸŸ¢ íŒë§¤ì¤‘' : 'ğŸ”´ íŒë§¤ì™„ë£Œ'}
                            </div>
                            ${!item.available && item.buyerName ? 
                                `<p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">êµ¬ë§¤ì: ${item.buyerName}</p>` : ''
                            }
                        </div>
                        
                        ${item.available && !isMyItem ? 
                            `<button class="btn ${this.currentUser.points >= item.price ? '' : ''}" 
                                    onclick="market.buyItemAction('${item.docId}'); this.closest('.modal').remove();"
                                    ${this.currentUser.points < item.price ? 'disabled' : ''}>
                                ${this.currentUser.points >= item.price ? 'êµ¬ë§¤í•˜ê¸°' : 'í¬ì¸íŠ¸ ë¶€ì¡±'}
                            </button>` : ''
                        }
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                document.body.appendChild(modal);
            }
            
            // ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
	   editItem(itemId) {
    		const item = this.items.find(i => i.docId === itemId);
    		if (item && item.sellerId === this.currentUser.id) {
		   this.editingItem = item;
                   this.selectedCategory = item.category;
        	   this.setPage('edit-item');
    		} else {
        		alert('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        this.setPage('my-items');
   		}
	     }

            // í™ˆ í™”ë©´
            renderHome() {
                return `
                    <div class="mobile-container">
                        <div class="card" style="text-align: center;">
                            <h1 style="color: #92400e; font-size: 64px; margin-bottom: 16px;">ğŸª</h1>
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 8px;">${this.teacherSettings.className}</h2>
                            <h3 style="color: #d97706; font-size: 18px; margin-bottom: 32px;"> êµì‹¤ ì‹œì¥ë†€ì´</h3>
                            <button class="btn" onclick="market.setPage('teacher-login')">
                                ğŸ‘©â€ğŸ« ì„ ìƒë‹˜ ëª¨ë“œ
                            </button>
                            
                            <button class="btn btn-secondary" onclick="market.setPage('student-login')">
                                ğŸ‘¦ í•™ìƒ ëª¨ë“œ
                            </button>
			    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #fde68a; text-align: center;">
    <p style="font-size: 12px; color: #9ca3af;">Â© 2025 Ji Eun Park </p>
                        </div>
                    </div>
                `;
            }
            
            // êµì‚¬ ë¡œê·¸ì¸ ì„ íƒ
            renderTeacherLogin() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('home')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card" style="text-align: center;">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 24px;">ì„ ìƒë‹˜ ë¡œê·¸ì¸</h2>
                            
                            <button class="btn" onclick="market.setPage('teacher-pin')">
                                ğŸ”‘ PIN ì…ë ¥í•˜ê¸°
                            </button>
                            
                            <button class="btn btn-outline" onclick="market.setPage('teacher-settings')">
                                âš™ï¸ ì²˜ìŒ ì„¤ì •í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // êµì‚¬ PIN ì…ë ¥
            renderTeacherPin() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('teacher-login')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card pin-container">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 16px;">ì„ ìƒë‹˜ í™•ì¸</h2>
                            <p style="color: #d97706; margin-bottom: 24px;">êµì‚¬ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            ${this.teacherSettings.isFirstTime ? 
                                `<div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #92400e;">
                                    ğŸ’¡ ê¸°ë³¸ PIN: <strong>0000</strong><br>
                                    ì²˜ìŒ ë¡œê·¸ì¸ í›„ ì„¤ì •ì—ì„œ ë³€ê²½í•˜ì„¸ìš”!
                                </div>` : ''
                            }
                            
                            <input type="password" id="teacherPinInput" class="input pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
                            
                            <button class="btn" onclick="market.verifyTeacherPin()">
                                ì…ì¥í•˜ê¸°
                            </button>
                            
                            <div id="teacherPinError" style="color: #dc2626; margin-top: 16px; text-align: center; display: none;">
                                PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // í•™ìƒ ë¡œê·¸ì¸
            renderStudentLogin() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('home')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card pin-container">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 16px;">í•™ìƒ ë¡œê·¸ì¸</h2>
                            <p style="color: #d97706; margin-bottom: 24px;">ì¶œì„ë²ˆí˜¸ì™€ PINì„ ì…ë ¥í•˜ì„¸ìš”</p>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ì¶œì„ë²ˆí˜¸</label>
                                <input type="number" id="studentNumber" class="input" placeholder="ì¶œì„ë²ˆí˜¸ (ì˜ˆ: 5)" min="1" max="50">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">PIN ë²ˆí˜¸</label>
                                <input type="password" id="studentPinInput" class="input pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
                            </div>
                            
                            <button class="btn" onclick="market.loginByNumber()">
                                ì…ì¥í•˜ê¸°
                            </button>
                            
                            <div id="studentLoginError" style="color: #dc2626; margin-top: 16px; text-align: center; display: none;">
                                ì¶œì„ë²ˆí˜¸ ë˜ëŠ” PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤
                            </div>
                            
                            <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                                <p style="font-size: 12px; color: #d97706; text-align: center;">
                                    ğŸ’¡ ì¶œì„ë²ˆí˜¸ëŠ” ì„ ìƒë‹˜ì´ ì•Œë ¤ì£¼ì‹  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // êµì‚¬ ì„¤ì •
            renderTeacherSettings() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('teacher-dashboard')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 24px; text-align: center;">êµì‚¬ ì„¤ì •</h2>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">í•™ê¸‰ëª…</label>
                                <input type="text" id="className" class="input" value="${this.teacherSettings.className}">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">êµì‚¬ PIN (4ìë¦¬)</label>
                                <input type="password" id="teacherPin" class="input" value="${this.teacherSettings.pin}" maxlength="4">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #92400e; margin-bottom: 8px; font-weight: bold;">ğŸ“Š í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</label>
                                
                                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <h4 style="color: #92400e; margin-bottom: 8px;">ğŸ“¥ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h4>
                                    <p style="color: #d97706; font-size: 14px; margin-bottom: 12px;">ì—‘ì…€ í˜•íƒœ: ë²ˆí˜¸ | ì´ë¦„ | PIN | í¬ì¸íŠ¸</p>
                                    
                                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 12px;">
                                    
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="btn btn-secondary" onclick="market.uploadExcel()" style="flex: 1; min-width: 120px;">
                                            ğŸ“¤ ì—…ë¡œë“œ
                                        </button>
                                        <button class="btn btn-outline" onclick="market.downloadSample()" style="flex: 1; min-width: 120px;">
                                            ğŸ“‹ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="background: #fef3c7; padding: 16px; border-radius: 8px;">
                                    <h4 style="color: #92400e; margin-bottom: 8px;">âš¡ ë¹ ë¥¸ ì„¤ì •</h4>
                                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                        <select id="quickStudentCount" class="input" style="flex: 1;">
                                            <option value="20">20ëª…</option>
                                            <option value="25" selected>25ëª…</option>
                                            <option value="30">30ëª…</option>
                                            <option value="35">35ëª…</option>
                                        </select>
                                        <input type="number" id="quickDefaultPoints" class="input" placeholder="ê¸°ë³¸ í¬ì¸íŠ¸" value="100" style="flex: 1;">
                                    </div>
                                    <button class="btn btn-outline" onclick="market.quickSetupAction()" style="width: 100%;">
                                        ê¸°ë³¸ í•™ìƒ ëª©ë¡ ìƒì„±
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn" onclick="market.saveTeacherSettings()">
                                ì„¤ì • ì €ì¥
                            </button>
                            
                            <div style="margin-top: 16px;">
                                <button class="btn btn-outline" onclick="market.resetAllData()" 
                                        style="background: #dc2626; color: white; border-color: #dc2626;">
                                    âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // êµì‚¬ ëŒ€ì‹œë³´ë“œ
            renderTeacherDashboard() {
                return `
                    <div class="container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <h1 style="color: #92400e; font-size: 28px;">êµì‚¬ ê´€ë¦¬ í˜ì´ì§€</h1>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="market.setPage('teacher-settings')" style="width: auto; padding: 8px 16px;">
                                    âš™ï¸ ì„¤ì •
                                </button>
                                <button class="btn btn-outline" onclick="market.logout()" style="width: auto; padding: 8px 16px;">
                                    ë¡œê·¸ì•„ì›ƒ
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: #dcfce7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 2px solid #059669;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                                <div>
                                    <h3 style="color: #059669; margin-bottom: 4px;">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</h3>
                                    <p style="color: #047857; font-size: 14px;">í•™ìƒ ${this.students.length}ëª… â€¢ ìƒí’ˆ ${this.items.filter(i => i.available).length}ê°œ íŒë§¤ì¤‘ â€¢ ê±°ë˜ ${this.transactions.length}ê±´</p>
                                </div>
                                <div style="color: #059669; font-size: 24px;">ğŸŸ¢</div>
                            </div>
                        </div>
                        
                        ${this.teacherSettings.isFirstTime ? 
                            `<div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 2px solid #f59e0b;">
                                <h3 style="color: #92400e; margin-bottom: 8px;">ğŸ”” ì²˜ìŒ ì‚¬ìš©í•˜ì‹œëŠ”êµ°ìš”!</h3>
                                <p style="color: #d97706; margin-bottom: 12px;">ì„¤ì •ì—ì„œ êµì‚¬ PINì„ ë³€ê²½í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. (í˜„ì¬: 0000)</p>
                                <button class="btn btn-secondary" onclick="market.setPage('teacher-settings')" style="width: auto; padding: 8px 16px;">
                                    ì§€ê¸ˆ ì„¤ì •í•˜ê¸°
                                </button>
                            </div>` : ''
                        }
                        
                        <div class="grid">
                            <div class="card">
                                <h3 style="color: #92400e; font-size: 20px; margin-bottom: 16px;">ğŸ’° í•™ìƒ ê´€ë¦¬</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${this.students.map(student => `
                                        <div class="student-points">
                                            <div>
                                                <input type="text" value="${student.name}" 
                                                       onchange="market.updateStudentName(${student.id}, this.value)"
                                                       style="border: none; background: transparent; font-weight: bold; color: #92400e;">
                                                <div style="font-size: 12px; color: #d97706;">PIN: ${student.pin}</div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" value="${student.points}" 
                                                       onchange="market.updateStudentPoints(${student.id}, this.value)"
                                                       style="width: 80px; padding: 4px; border: 1px solid #fde68a; border-radius: 4px; text-align: center;">
                                                <span style="color: #d97706;">P</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h3 style="color: #92400e; font-size: 20px;">ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
                                    <button class="btn btn-outline" onclick="market.setPage('teacher-transactions')" style="width: auto; padding: 6px 12px; font-size: 14px;">
                                        ìƒì„¸ ë³´ê¸°
                                    </button>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${this.transactions.length === 0 ? 
                                        '<p style="color: #d97706; text-align: center; padding: 32px;">ì•„ì§ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>' :
                                        this.transactions.slice(0, 5).map(transaction => `
                                            <div class="transaction-item">
                                                <div style="font-size: 14px; color: #92400e; margin-bottom: 4px;">
                                                    <strong>${transaction.buyerName}</strong> â†’ <strong>${transaction.sellerName}</strong>
                                                </div>
                                                <div style="font-size: 12px; color: #d97706;">
                                                    ${transaction.itemTitle} â€¢ ${transaction.price}P â€¢ ${transaction.timestamp ? new Date(transaction.timestamp.seconds * 1000).toLocaleString('ko-KR') : 'ë°©ê¸ˆ'}
                                                </div>
                                            </div>
                                        `).join('')
                                    }
                                    ${this.transactions.length > 5 ? 
                                        '<div style="text-align: center; margin-top: 12px; font-size: 12px; color: #d97706;">ë” ë§ì€ ê±°ë˜ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤</div>' : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // í•™ìƒ ëŒ€ì‹œë³´ë“œ
            renderStudentDashboard() {
                return `
                    <div class="mobile-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h1 style="color: #92400e; font-size: 20px;">${this.currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
                            <button class="btn btn-outline" onclick="market.logout()" style="width: auto; padding: 6px 12px; font-size: 14px;">
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                        
                        <div class="points-display">
                            <div class="points-number">${this.currentUser.points.toLocaleString()}</div>
                            <div class="points-label">ë³´ìœ  í¬ì¸íŠ¸</div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <button class="btn" onclick="market.setPage('student-shop')">
                                ğŸ›’ ìƒì  êµ¬ê²½í•˜ê¸°
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-secondary" onclick="market.setPage('add-item')">
                                â• ë¬¼ê±´ ë“±ë¡í•˜ê¸°
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-outline" onclick="market.setPage('my-items')" style="background: #dbeafe; color: #1e40af; border-color: #3b82f6;">
                                ğŸ“¦ ë‚´ ë¬¼ê±´ ë³´ê¸°
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-outline" onclick="market.setPage('change-pin')" style="background: #fef3c7; color: #92400e; border-color: #f59e0b;">
                                ğŸ” PIN ë²ˆí˜¸ ë³€ê²½
                            </button>
                        </div>
                        
                        <div>
                            <button class="btn btn-outline" onclick="market.setPage('my-transactions')" style="background: #f3f4f6; color: #374151; border-color: #d1d5db;">
                                ğŸ“‹ ë‚´ ê±°ë˜ ë‚´ì—­
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // ìƒì  (ê°œì„ ëœ ì»´íŒ©íŠ¸ ì¹´ë“œ)
            renderShop() {
                const filteredItems = this.items.filter(item => 
                    item.sellerId !== this.currentUser.id &&
                    (this.shopCategoryFilter === 'all' || item.category === this.shopCategoryFilter)
                );
                
                return `
                    <div class="container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h1 style="color: #92400e; font-size: 28px;">ğŸ›’ ìƒì </h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div style="background: #fef3c7; padding: 8px 16px; border-radius: 8px; font-weight: bold; color: #92400e;">
                                    ${this.currentUser.points.toLocaleString()}P
                                </div>
                                <button class="btn btn-outline" onclick="market.setPage('student-dashboard')" style="width: auto; padding: 8px 16px;">
                                    â† ëŒì•„ê°€ê¸°
                                </button>
                            </div>
                        </div>
                        
                        <div class="filter-tabs">
                            <div class="filter-tab ${this.shopCategoryFilter === 'all' ? 'active' : ''}" 
                                 onclick="market.setShopCategoryFilter('all')">
                                ì „ì²´ (${this.items.filter(i => i.sellerId !== this.currentUser.id).length})
                            </div>
                            ${CATEGORIES.map(cat => `
                                <div class="filter-tab ${this.shopCategoryFilter === cat.id ? 'active' : ''}" 
                                     onclick="market.setShopCategoryFilter('${cat.id}')">
                                    ${cat.emoji} ${cat.name.split(' ')[1]} (${this.items.filter(i => i.sellerId !== this.currentUser.id && i.category === cat.id).length})
                                </div>
                            `).join('')}
                        </div>
                        
                        ${filteredItems.length === 0 ? 
                            `<div class="card" style="text-align: center; padding: 60px;">
                                <h3 style="color: #d97706; margin-bottom: 16px;">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p style="color: #9ca3af;">ì¹œêµ¬ë“¤ì´ ë¬¼ê±´ì„ ë“±ë¡í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
                            </div>` :
                            `<div class="shop-grid">
                                ${filteredItems.map(item => {
                                    const category = CATEGORIES.find(c => c.id === item.category);
                                    return `
                                        <div class="shop-item-card" onclick="market.showItemDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                            ${item.imageUrl ? `
                                                <div class="shop-item-image">
                                                    <img src="${item.imageUrl}" alt="${item.title}">
                                                </div>
                                            ` : `
                                                <div class="shop-item-emoji">${item.emoji}</div>
                                            `}
                                            <div class="shop-item-price">${item.price.toLocaleString()}P</div>
                                            <div class="shop-item-title">${item.title}</div>
                                            <div class="shop-item-status ${item.available ? 'status-available' : 'status-sold'}">
                                                ${item.available ? 'íŒë§¤ì¤‘' : 'íŒë§¤ì™„ë£Œ'}
                                            </div>
                                            ${!item.available ? 
                                                `<div style="font-size: 12px; color: #9ca3af; text-align: center;">êµ¬ë§¤ì: ${item.buyerName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>` : 
                                                ''
                                            }
                                        </div>
                                    `;
                                }).join('')}
                            </div>`
                        }
                    </div>
                `;
            }
            
            // ë¬¼ê±´ ë“±ë¡ (ì´ëª¨ì§€ ì„ íƒ ì œê±°)
            renderAddItem() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('student-dashboard')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 24px; text-align: center;">ë¬¼ê±´ ë“±ë¡í•˜ê¸°</h2>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 8px; font-weight: bold;">ğŸ“¸ ìƒí’ˆ ì‚¬ì§„ (ì„ íƒì‚¬í•­)</label>
                                <div class="photo-upload ${this.selectedImageFile ? 'has-image' : ''}" onclick="document.getElementById('imageInput').click()">
                                    ${this.selectedImageFile ? 
                                        `<img src="${URL.createObjectURL(this.selectedImageFile)}" class="photo-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
                                         <p style="margin-top: 8px; color: #059669; font-size: 14px;">âœ… ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤</p>` :
                                        `<div style="color: #9ca3af; text-align: center;">
                                            <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“¸</div>
                                            <p>ì‚¬ì§„ì„ ì„ íƒí•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                                            <p style="font-size: 12px; margin-top: 4px;">JPG, PNG íŒŒì¼ë§Œ ê°€ëŠ¥</p>
                                        </div>`
                                    }
                                </div>
                                <input type="file" id="imageInput" accept="image/*" style="display: none;" 
                                       onchange="market.handleImageSelect(this.files[0])">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 8px; font-weight: bold;">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì„ íƒ *</label>
                                <div class="category-grid">
                                    ${CATEGORIES.map(category => `
                                        <button type="button" class="category-btn ${this.selectedCategory === category.id ? 'selected' : ''}" 
                                                onclick="market.selectCategory('${category.id}')">
                                            ${category.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ë¬¼ê±´ ì´ë¦„ *</label>
                                <input type="text" id="itemTitle" class="input" placeholder="ì˜ˆ: ìƒˆ ì—°í•„í†µ">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ì„¤ëª…</label>
                                <input type="text" id="itemDescription" class="input" placeholder="ì˜ˆ: ê±°ì˜ ìƒˆ ê²ƒì´ì—ìš”!">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ê°€ê²© *</label>
                                <select id="itemPrice" class="input">
                                    <option value="">ê°€ê²©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="500">500P</option>
                                    <option value="1000">1,000P</option>
                                    <option value="1500">1,500P</option>
                                    <option value="2000">2,000P</option>
                                    <option value="2500">2,500P</option>
                                    <option value="3000">3,000P</option>
                                    <option value="3500">3,500P</option>
                                    <option value="4000">4,000P</option>
                                    <option value="4500">4,500P</option>
                                    <option value="5000">5,000P</option>
                                </select>
                            </div>
                            
                            <button class="btn" onclick="market.addItemAction()" 
                                    ${!this.selectedCategory ? 'disabled' : ''}>
                                ë“±ë¡í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // ë¬¼ê±´ ìˆ˜ì •
            renderEditItem() {               
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('my-items')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 24px; text-align: center;">ë¬¼ê±´ ìˆ˜ì •í•˜ê¸°</h2>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 8px; font-weight: bold;">ğŸ“¸ ìƒí’ˆ ì‚¬ì§„</label>
                                <div class="photo-upload ${this.selectedImageFile || this.editingItem.imageUrl ? 'has-image' : ''}" onclick="document.getElementById('editImageInput').click()">
                                    ${this.selectedImageFile ? 
                                        `<img src="${URL.createObjectURL(this.selectedImageFile)}" class="photo-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
                                         <p style="margin-top: 8px; color: #059669; font-size: 14px;">âœ… ìƒˆ ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤</p>` :
                                        this.editingItem.imageUrl ? 
                                        `<img src="${this.editingItem.imageUrl}" class="photo-preview" alt="í˜„ì¬ ì‚¬ì§„">
                                         <p style="margin-top: 8px; color: #92400e; font-size: 14px;">í˜„ì¬ ì‚¬ì§„ (í´ë¦­í•˜ì—¬ ë³€ê²½)</p>` :
                                        `<div style="color: #9ca3af; text-align: center;">
                                            <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“¸</div>
                                            <p>ì‚¬ì§„ì„ ì„ íƒí•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                                            <p style="font-size: 12px; margin-top: 4px;">JPG, PNG íŒŒì¼ë§Œ ê°€ëŠ¥</p>
                                        </div>`
                                    }
                                </div>
                                <input type="file" id="editImageInput" accept="image/*" style="display: none;" 
                                       onchange="market.handleImageSelect(this.files[0])">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 8px; font-weight: bold;">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì„ íƒ *</label>
                                <div class="category-grid">
                                    ${CATEGORIES.map(category => `
                                        <button type="button" class="category-btn ${this.selectedCategory === category.id ? 'selected' : ''}" 
                                                onclick="market.selectCategory('${category.id}')">
                                            ${category.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ë¬¼ê±´ ì´ë¦„ *</label>
                                <input type="text" id="editItemTitle" class="input" value="${this.editingItem.title}">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ì„¤ëª…</label>
                                <input type="text" id="editItemDescription" class="input" value="${this.editingItem.description}">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ê°€ê²© *</label>
                                <select id="editItemPrice" class="input">
                                    <option value="">ê°€ê²©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="500" ${this.editingItem.price === 500 ? 'selected' : ''}>500P</option>
                                    <option value="1000" ${this.editingItem.price === 1000 ? 'selected' : ''}>1,000P</option>
                                    <option value="1500" ${this.editingItem.price === 1500 ? 'selected' : ''}>1,500P</option>
                                    <option value="2000" ${this.editingItem.price === 2000 ? 'selected' : ''}>2,000P</option>
                                    <option value="2500" ${this.editingItem.price === 2500 ? 'selected' : ''}>2,500P</option>
                                    <option value="3000" ${this.editingItem.price === 3000 ? 'selected' : ''}>3,000P</option>
                                    <option value="3500" ${this.editingItem.price === 3500 ? 'selected' : ''}>3,500P</option>
                                    <option value="4000" ${this.editingItem.price === 4000 ? 'selected' : ''}>4,000P</option>
                                    <option value="4500" ${this.editingItem.price === 4500 ? 'selected' : ''}>4,500P</option>
                                    <option value="5000" ${this.editingItem.price === 5000 ? 'selected' : ''}>5,000P</option>
                                </select>
                            </div>
                            
                            <button class="btn" onclick="market.updateItemAction()" 
                                    ${!this.selectedCategory ? 'disabled' : ''}>
                                ìˆ˜ì • ì™„ë£Œ
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // ë‚´ ë¬¼ê±´ ë³´ê¸° (ê°€ë¡œ ë ˆì´ì•„ì›ƒ)
            renderMyItems() {
                const myItems = this.items.filter(item => item.sellerId === this.currentUser.id);
                
                return `
                    <div class="container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h1 style="color: #92400e; font-size: 24px;">ë‚´ê°€ ë“±ë¡í•œ ë¬¼ê±´</h1>
                            <button class="btn btn-outline" onclick="market.setPage('student-dashboard')" style="width: auto; padding: 8px 16px;">
                                â† ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                        
                        ${myItems.length === 0 ? 
                            `<div class="card" style="text-align: center; padding: 60px;">
                                <h3 style="color: #d97706; margin-bottom: 16px;">ë“±ë¡í•œ ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p style="color: #9ca3af; margin-bottom: 24px;">ì²« ë²ˆì§¸ ë¬¼ê±´ì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
                                <button class="btn" onclick="market.setPage('add-item')">ë¬¼ê±´ ë“±ë¡í•˜ê¸°</button>
                            </div>` :
                            `<div>
                                ${myItems.map(item => {
                                    return `
                                        <div class="my-item-card ${!item.available ? 'sold' : ''}">
                                            ${item.imageUrl ? `
                                                <div class="my-item-image">
                                                    <img src="${item.imageUrl}" alt="${item.title}">
                                                </div>
                                            ` : `
                                                <div class="my-item-image">
                                                    <div class="my-item-emoji">${item.emoji}</div>
                                                </div>
                                            `}
                                            
                                            <div class="my-item-info">
                                                <div class="my-item-title">${item.title}</div>
                                                <div class="my-item-price">${item.price.toLocaleString()}P</div>
                                                <div class="my-item-status">
                                                    ${item.available ? 
                                                        '<span style="color: #059669; font-weight: bold;">ğŸŸ¢ íŒë§¤ì¤‘</span>' : 
                                                        `<span style="color: #dc2626; font-weight: bold;">ğŸ”´ íŒë§¤ì™„ë£Œ</span>${item.buyerName ? ` â€¢ êµ¬ë§¤ì: ${item.buyerName}` : ''}`
                                                    }
                                                </div>
                                                
                                                ${item.available ? `
                                                    <div class="my-item-actions">
                                                        <button class="btn btn-small btn-outline" onclick="market.editItem('${item.docId}')">
                                                            ìˆ˜ì •
                                                        </button>
                                                        <button class="btn btn-small btn-danger" onclick="market.deleteItemAction('${item.docId}')">
                                                            ì‚­ì œ
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>`
                        }
                    </div>
                `;
            }
            
            // í•™ìƒ ê±°ë˜ ë‚´ì—­
            renderMyTransactions() {
                const myPurchases = this.transactions.filter(t => t.buyerId === this.currentUser.id);
                const mySales = this.transactions.filter(t => t.sellerId === this.currentUser.id);
                
                return `
                    <div class="container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h1 style="color: #92400e; font-size: 24px;">ë‚´ ê±°ë˜ ë‚´ì—­</h1>
                            <button class="btn btn-outline" onclick="market.setPage('student-dashboard')" style="width: auto; padding: 8px 16px;">
                                â† ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                        
                        <div class="grid">
                            <div class="card">
                                <h3 style="color: #92400e; font-size: 20px; margin-bottom: 16px;">ğŸ“¥ êµ¬ë§¤í•œ ë¬¼ê±´ (${myPurchases.length}ê°œ)</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${myPurchases.length === 0 ? 
                                        '<p style="color: #d97706; text-align: center; padding: 32px;">ì•„ì§ êµ¬ë§¤í•œ ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤</p>' :
                                        myPurchases.map(transaction => `
                                            <div class="transaction-item">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                                    <div style="font-size: 16px; color: #92400e; font-weight: bold;">
                                                        ${transaction.itemTitle}
                                                    </div>
                                                    <div style="font-size: 18px; color: #dc2626; font-weight: bold;">
                                                        -${transaction.price.toLocaleString()}P
                                                    </div>
                                                </div>
                                                <div style="font-size: 14px; color: #d97706;">
                                                    íŒë§¤ì: ${transaction.sellerName}
                                                </div>
                                                <div style="font-size: 12px; color: #9ca3af;">
                                                    ${transaction.timestamp ? new Date(transaction.timestamp.seconds * 1000).toLocaleString('ko-KR') : 'ë°©ê¸ˆ'}
                                                </div>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3 style="color: #92400e; font-size: 20px; margin-bottom: 16px;">ğŸ“¤ íŒë§¤í•œ ë¬¼ê±´ (${mySales.length}ê°œ)</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${mySales.length === 0 ? 
                                        '<p style="color: #d97706; text-align: center; padding: 32px;">ì•„ì§ íŒë§¤í•œ ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤</p>' :
                                        mySales.map(transaction => `
                                            <div class="transaction-item">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                                    <div style="font-size: 16px; color: #92400e; font-weight: bold;">
                                                        ${transaction.itemTitle}
                                                    </div>
                                                    <div style="font-size: 18px; color: #059669; font-weight: bold;">
                                                        +${transaction.price.toLocaleString()}P
                                                    </div>
                                                </div>
                                                <div style="font-size: 14px; color: #d97706;">
                                                    êµ¬ë§¤ì: ${transaction.buyerName}
                                                </div>
                                                <div style="font-size: 12px; color: #9ca3af;">
                                                    ${transaction.timestamp ? new Date(transaction.timestamp.seconds * 1000).toLocaleString('ko-KR') : 'ë°©ê¸ˆ'}
                                                </div>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h3 style="color: #92400e; font-size: 20px; margin-bottom: 16px;">ğŸ’° í¬ì¸íŠ¸ ìš”ì•½</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                <div style="text-align: center; background: #fef3c7; padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #92400e;">
                                        ${this.currentUser.points.toLocaleString()}P
                                    </div>
                                    <div style="font-size: 14px; color: #d97706;">í˜„ì¬ ë³´ìœ </div>
                                </div>
                                <div style="text-align: center; background: #fee2e2; padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #dc2626;">
                                        -${myPurchases.reduce((sum, t) => sum + t.price, 0).toLocaleString()}P
                                    </div>
                                    <div style="font-size: 14px; color: #991b1b;">ì´ ì§€ì¶œ</div>
                                </div>
                                <div style="text-align: center; background: #dcfce7; padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #059669;">
                                        +${mySales.reduce((sum, t) => sum + t.price, 0).toLocaleString()}P
                                    </div>
                                    <div style="font-size: 14px; color: #047857;">ì´ ìˆ˜ì…</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // PIN ë³€ê²½ í˜ì´ì§€
            renderChangePin() {
                return `
                    <div class="mobile-container">
                        <button class="back-btn" onclick="market.setPage('student-dashboard')">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        
                        <div class="card">
                            <h2 style="color: #92400e; font-size: 24px; margin-bottom: 24px; text-align: center;">ğŸ” PIN ë²ˆí˜¸ ë³€ê²½</h2>
                            
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <p style="color: #92400e; font-size: 14px; text-align: center;">
                                    <strong>í˜„ì¬ PIN:</strong> ${this.currentUser.pin}<br>
                                    <span style="color: #d97706; font-size: 12px;">ë³´ì•ˆì„ ìœ„í•´ ìƒˆë¡œìš´ PINìœ¼ë¡œ ë³€ê²½í•´ë³´ì„¸ìš”!</span>
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">í˜„ì¬ PIN ë²ˆí˜¸ *</label>
                                <input type="password" id="currentPin" class="input pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ìƒˆ PIN ë²ˆí˜¸ *</label>
                                <input type="password" id="newPin" class="input pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #92400e; margin-bottom: 4px; font-weight: bold;">ìƒˆ PIN ë²ˆí˜¸ ì¬í™•ì¸ *</label>
                                <input type="password" id="confirmPin" class="input pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
                            </div>
                            
                            <button class="btn" onclick="market.changePinAction()">
                                PIN ë²ˆí˜¸ ë³€ê²½
                            </button>
                            
                            <div id="changePinError" style="color: #dc2626; margin-top: 16px; text-align: center; display: none;">
                            </div>
                            
                            <div style="margin-top: 20px; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                                <h4 style="color: #0369a1; margin-bottom: 8px;">ğŸ’¡ PIN ë²ˆí˜¸ ì•ˆì „ ìˆ˜ì¹™</h4>
                                <ul style="color: #0369a1; font-size: 12px; margin-left: 16px;">
                                    <li>4ìë¦¬ ìˆ«ìë¡œ ì„¤ì •í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // êµì‚¬ ê±°ë˜ ë‚´ì—­ ìƒì„¸
            renderTeacherTransactions() {
                const selectedStudent = this.selectedStudentForTransactions || null;
                let filteredTransactions = this.transactions;
                
                if (selectedStudent) {
                    filteredTransactions = this.transactions.filter(t => 
                        t.buyerId === selectedStudent.id || t.sellerId === selectedStudent.id
                    );
                }
                
                return `
                    <div class="container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h1 style="color: #92400e; font-size: 24px;">ê±°ë˜ ë‚´ì—­ ìƒì„¸</h1>
                            <button class="btn btn-outline" onclick="market.setPage('teacher-dashboard')" style="width: auto; padding: 8px 16px;">
                                â† ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                        
                        <div class="card" style="margin-bottom: 20px;">
                            <h3 style="color: #92400e; font-size: 18px; margin-bottom: 16px;">ğŸ” í•™ìƒë³„ ê²€ìƒ‰</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn ${!selectedStudent ? 'btn-secondary' : 'btn-outline'}" 
                                        onclick="market.filterTransactionsByStudent(null)" 
                                        style="width: auto; padding: 8px 16px;">
                                    ì „ì²´ ë³´ê¸°
                                </button>
                                ${this.students.map(student => `
                                    <button class="btn ${selectedStudent && selectedStudent.id === student.id ? 'btn-secondary' : 'btn-outline'}" 
                                            onclick="market.filterTransactionsByStudent(${student.id})" 
                                            style="width: auto; padding: 8px 16px; font-size: 14px;">
                                        ${student.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="color: #92400e; font-size: 18px;">
                                    ğŸ“‹ ê±°ë˜ ë‚´ì—­ 
                                    ${selectedStudent ? `(${selectedStudent.name})` : `(ì „ì²´ ${filteredTransactions.length}ê±´)`}
                                </h3>
                            </div>
                            
                            <div style="max-height: 500px; overflow-y: auto;">
                                ${filteredTransactions.length === 0 ? 
                                    '<p style="color: #d97706; text-align: center; padding: 32px;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>' :
                                    filteredTransactions.map(transaction => `
                                        <div class="transaction-item">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <div style="font-size: 16px; color: #92400e; font-weight: bold; margin-bottom: 4px;">
                                                        ${transaction.itemTitle}
                                                    </div>
                                                    <div style="font-size: 14px; color: #d97706;">
                                                        <strong>${transaction.buyerName}</strong> â†’ <strong>${transaction.sellerName}</strong>
                                                    </div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 18px; font-weight: bold; color: #92400e;">
                                                        ${transaction.price.toLocaleString()}P
                                                    </div>
                                                    <div style="font-size: 12px; color: #9ca3af;">
                                                        ${transaction.timestamp ? new Date(transaction.timestamp.seconds * 1000).toLocaleString('ko-KR') : 'ë°©ê¸ˆ'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            attachEventListeners() {
                // êµì‚¬ PIN ì…ë ¥ ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
                const teacherPinInput = document.getElementById('teacherPinInput');
                if (teacherPinInput) {
                    teacherPinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.verifyTeacherPin();
                        }
                    });
                }
                
                // í•™ìƒ ë¡œê·¸ì¸ ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
                const studentPinInput = document.getElementById('studentPinInput');
                if (studentPinInput) {
                    studentPinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.loginByNumber();
                        }
                    });
                }
                
                const studentNumber = document.getElementById('studentNumber');
                if (studentNumber) {
                    studentNumber.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('studentPinInput').focus();
                        }
                    });
                }
                
                // PIN ë³€ê²½ ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
                const currentPinInput = document.getElementById('currentPin');
                const newPinInput = document.getElementById('newPin');
                const confirmPinInput = document.getElementById('confirmPin');
                
                if (currentPinInput) {
                    currentPinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('newPin').focus();
                        }
                    });
                }
                
                if (newPinInput) {
                    newPinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('confirmPin').focus();
                        }
                    });
                }
                
                if (confirmPinInput) {
                    confirmPinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.changePinAction();
                        }
                    });
                }
            }
            
            // ì—‘ì…€ ì—…ë¡œë“œ
            async uploadExcel() {
                const fileInput = document.getElementById('excelFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    const data = await this.readExcelFile(file);
                    await this.processExcelData(data);
                    alert(`${data.length}ëª…ì˜ í•™ìƒ ì •ë³´ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    console.error(error);
                }
            }
            
            // ì—‘ì…€ íŒŒì¼ ì½ê¸°
            async readExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            resolve(jsonData);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            downloadSample() {
                const sampleData = [
                    { 'ë²ˆí˜¸': 1, 'ì´ë¦„': 'ê¹€ì² ìˆ˜', 'PIN': '1234', 'í¬ì¸íŠ¸': 100 },
                    { 'ë²ˆí˜¸': 2, 'ì´ë¦„': 'ë°•ì˜í¬', 'PIN': '5678', 'í¬ì¸íŠ¸': 150 },
                    { 'ë²ˆí˜¸': 3, 'ì´ë¦„': 'ì´ë¯¼ì¤€', 'PIN': '9012', 'í¬ì¸íŠ¸': 120 },
                    { 'ë²ˆí˜¸': 4, 'ì´ë¦„': 'ìµœì§€ì›', 'PIN': '3456', 'í¬ì¸íŠ¸': 100 },
                    { 'ë²ˆí˜¸': 5, 'ì´ë¦„': 'ì •ìˆ˜í˜„', 'PIN': '7890', 'í¬ì¸íŠ¸': 180 }
                ];
                
                const ws = XLSX.utils.json_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "í•™ìƒëª…ë‹¨");
                XLSX.writeFile(wb, "í•™ìƒëª…ë‹¨_ìƒ˜í”Œ.xlsx");
            }
            
            // ë¹ ë¥¸ ì„¤ì • ì•¡ì…˜
            async quickSetupAction() {
                const count = parseInt(document.getElementById('quickStudentCount').value);
                const points = parseInt(document.getElementById('quickDefaultPoints').value);
                
                try {
                    await this.quickSetup(count, points);
                    alert(`${count}ëª…ì˜ í•™ìƒ ëª©ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } catch (error) {
                    alert('í•™ìƒ ëª©ë¡ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error(error);
                }
            }
            
            // ì¶œì„ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸
            loginByNumber() {
                const studentNumber = parseInt(document.getElementById('studentNumber').value);
                const pin = document.getElementById('studentPinInput').value;
                const errorDiv = document.getElementById('studentLoginError');
                
                if (!studentNumber || !pin) {
                    errorDiv.textContent = 'ì¶œì„ë²ˆí˜¸ì™€ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const student = this.students.find(s => s.id === studentNumber);
                
                if (!student) {
                    errorDiv.textContent = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¶œì„ë²ˆí˜¸ì…ë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                if (student.pin !== pin) {
                    errorDiv.textContent = 'PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    document.getElementById('studentPinInput').value = '';
                    return;
                }
                
                // ë¡œê·¸ì¸ ì„±ê³µ
                this.setUser(student);
                this.setPage('student-dashboard');
            }
            
            // êµì‚¬ ì„¤ì • ì €ì¥
            async saveTeacherSettings() {
                const className = document.getElementById('className').value;
                const teacherPin = document.getElementById('teacherPin').value;
                
                if (!className || !teacherPin || teacherPin.length !== 4) {
                    alert('í•™ê¸‰ëª…ê³¼ êµì‚¬ PIN(4ìë¦¬)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    // ì„¤ì • ì—…ë°ì´íŠ¸
                    this.teacherSettings.className = className;
                    this.teacherSettings.pin = teacherPin;
                    this.teacherSettings.isFirstTime = false;
                    
                    await this.saveTeacherSettingsToDb();
                    
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    this.setPage('teacher-dashboard');
                } catch (error) {
                    alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error(error);
                }
            }
            
            // ì•¡ì…˜ ë©”ì„œë“œë“¤
            verifyTeacherPin() {
                const pin = document.getElementById('teacherPinInput').value;
                const errorDiv = document.getElementById('teacherPinError');
                
                if (pin === this.teacherSettings.pin) {
                    this.setUser({ id: 'teacher', name: 'ì„ ìƒë‹˜', role: 'teacher' });
                    this.setPage('teacher-dashboard');
                } else {
                    errorDiv.style.display = 'block';
                    document.getElementById('teacherPinInput').value = '';
                }
            }
            
            // í•™ìƒë³„ ê±°ë˜ í•„í„°ë§
            filterTransactionsByStudent(studentId) {
                if (studentId) {
                    this.selectedStudentForTransactions = this.students.find(s => s.id === studentId);
                } else {
                    this.selectedStudentForTransactions = null;
                }
                this.render();
            }
            
            logout() {
                this.setUser(null);
                this.selectedStudent = null;
                this.selectedStudentForTransactions = null;
                this.selectedCategory = '';
                this.selectedImageFile = null;
                this.editingItem = null;
                this.setPage('home');
            }
            
            async addItemAction() {
                const title = document.getElementById('itemTitle').value;
                const description = document.getElementById('itemDescription').value;
                const price = document.getElementById('itemPrice').value;
                
                if (!title || !price || !this.selectedCategory) {
                    alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    let imageUrl = null;
                    
                    // ì´ë¯¸ì§€ê°€ ì„ íƒëœ ê²½ìš° ì—…ë¡œë“œ
                    if (this.selectedImageFile) {
                        imageUrl = await this.uploadImage(this.selectedImageFile);
                    }
                    
                    if (await this.addItem(title, description, price, this.selectedCategory, imageUrl)) {
                        alert('ë¬¼ê±´ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        this.setPage('student-shop');
                    } else {
                        alert('ë¬¼ê±´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ë¬¼ê±´ ë“±ë¡ ì˜¤ë¥˜:', error);
                    alert('ë¬¼ê±´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            async updateItemAction() {
                const title = document.getElementById('editItemTitle').value;
                const description = document.getElementById('editItemDescription').value;
                const price = document.getElementById('editItemPrice').value;
                
                if (!title || !price || !this.selectedCategory) {
                    alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    let imageUrl = null;
                    
                    // ìƒˆ ì´ë¯¸ì§€ê°€ ì„ íƒëœ ê²½ìš°ë§Œ ì—…ë¡œë“œ
                    if (this.selectedImageFile) {
                        imageUrl = await this.uploadImage(this.selectedImageFile);
                    }
                    
                    if (await this.updateItem(this.editingItem.docId, title, description, price, this.selectedCategory, imageUrl)) {
                        alert('ë¬¼ê±´ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        this.setPage('my-items');
                    } else {
                        alert('ë¬¼ê±´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ë¬¼ê±´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                    alert('ë¬¼ê±´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            async deleteItemAction(itemId) {
                if (await this.deleteItem(itemId)) {
                    alert('ë¬¼ê±´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë¬¼ê±´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            async buyItemAction(itemDocId) {
                const item = this.items.find(i => i.docId === itemDocId);
                if (item && await this.buyItem(item)) {
                    alert(`${item.title}ì„(ë¥¼) ì„±ê³µì ìœ¼ë¡œ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`);
                }
            }
            
            // PIN ë³€ê²½ ì•¡ì…˜
            async changePinAction() {
                const currentPin = document.getElementById('currentPin').value;
                const newPin = document.getElementById('newPin').value;
                const confirmPin = document.getElementById('confirmPin').value;
                const errorDiv = document.getElementById('changePinError');
                
                // ì…ë ¥ê°’ ê²€ì¦
                if (!currentPin || !newPin || !confirmPin) {
                    errorDiv.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // í˜„ì¬ PIN í™•ì¸
                if (currentPin !== this.currentUser.pin) {
                    errorDiv.textContent = 'í˜„ì¬ PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    document.getElementById('currentPin').value = '';
                    return;
                }
                
                // ìƒˆ PIN í˜•ì‹ ê²€ì¦
                if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                    errorDiv.textContent = 'PINì€ 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // ìƒˆ PIN í™•ì¸
                if (newPin !== confirmPin) {
                    errorDiv.textContent = 'ìƒˆ PINì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    document.getElementById('confirmPin').value = '';
                    return;
                }
                
                // ê°™ì€ PINì¸ì§€ í™•ì¸
                if (currentPin === newPin) {
                    errorDiv.textContent = 'í˜„ì¬ PINê³¼ ê°™ì€ ë²ˆí˜¸ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                try {
                    // PIN ì—…ë°ì´íŠ¸
                    const success = await this.updateStudentPin(this.currentUser.id, newPin);
                    
                    if (success) {
                        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                        this.currentUser.pin = newPin;
                        
                        alert('PIN ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        this.setPage('student-dashboard');
                    } else {
                        errorDiv.textContent = 'PIN ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('PIN ë³€ê²½ ì˜¤ë¥˜:', error);
                    errorDiv.textContent = 'PIN ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                }
            }
            
            // ë Œë”ë§
            render() {
                const app = document.getElementById('app');
                
                switch(this.currentPage) {
                    case 'teacher-login':
                        app.innerHTML = this.renderTeacherLogin();
                        break;
                    case 'teacher-pin':
                        app.innerHTML = this.renderTeacherPin();
                        break;
                    case 'teacher-settings':
                        app.innerHTML = this.renderTeacherSettings();
                        break;
                    case 'student-login':
                        app.innerHTML = this.renderStudentLogin();
                        break;
                    case 'teacher-dashboard':
                        app.innerHTML = this.renderTeacherDashboard();
                        break;
                    case 'student-dashboard':
                        app.innerHTML = this.renderStudentDashboard();
                        break;
                    case 'student-shop':
                        app.innerHTML = this.renderShop();
                        break;
                    case 'add-item':
                        app.innerHTML = this.renderAddItem();
                        break;
                    case 'edit-item':
                        app.innerHTML = this.renderEditItem();
                        break;
                    case 'my-items':
                        app.innerHTML = this.renderMyItems();
                        break;
                    case 'my-transactions':
                        app.innerHTML = this.renderMyTransactions();
                        break;
                    case 'change-pin':
                        app.innerHTML = this.renderChangePin();
                        break;
                    case 'teacher-transactions':
                        app.innerHTML = this.renderTeacherTransactions();
                        break;
                    default:
                        app.innerHTML = this.renderHome();
                }
                
                this.attachEventListeners();
            }
            
            // ì •ë¦¬
            destroy() {
                this.unsubscribers.forEach(unsubscribe => unsubscribe());
            }
        }

        // ì•± ì‹œì‘
        const market = new ClassMarket();
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            market.destroy();
        });
    </script>
</body>
</html>